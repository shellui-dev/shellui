@namespace BlazorInteractiveServer.Components.UI
@using BlazorInteractiveServer.Components

<div class="@Shell.Cn("relative", Class)" @attributes="AdditionalAttributes">
    <button type="button"
            @onclick="Toggle"
            disabled="@Disabled"
            class="@Shell.Cn("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2", Disabled ? "cursor-not-allowed opacity-50" : "")">
        <span class="@(Value == null ? "text-muted-foreground" : "")">
            @(Value?.ToString("HH:mm") ?? Placeholder)
        </span>
        <svg class="h-4 w-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </button>
    
    @if (IsOpen)
    {
        <div class="absolute z-50 mt-1 w-64 rounded-md border border-border bg-popover p-4 shadow-md animate-in fade-in-0 zoom-in-95">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <Label>Hour</Label>
                        <select @bind="selectedHour" class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                            @for (int h = 0; h < 24; h++)
                            {
                                <option value="@h">@h.ToString("D2")</option>
                            }
                        </select>
                    </div>
                    <div>
                        <Label>Minute</Label>
                        <select @bind="selectedMinute" class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                            @for (int m = 0; m < 60; m += 5)
                            {
                                <option value="@m">@m.ToString("D2")</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" @onclick="Close" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground h-9 px-4">
                        Cancel
                    </button>
                    <button type="button" @onclick="ApplyTime" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">
                        Apply
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@if (IsOpen)
{
    <div class="fixed inset-0 z-40" @onclick="Close"></div>
}

@code {
    [Parameter] public TimeSpan? Value { get; set; }
    [Parameter] public EventCallback<TimeSpan?> ValueChanged { get; set; }
    [Parameter] public string Placeholder { get; set; } = "Pick a time";
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public string? Class { get; set; }
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }
    
    private bool IsOpen { get; set; }
    private int selectedHour = 0;
    private int selectedMinute = 0;
    
    protected override void OnInitialized()
    {
        if (Value.HasValue)
        {
            selectedHour = Value.Value.Hours;
            selectedMinute = Value.Value.Minutes;
        }
    }
    
    private void Toggle() => IsOpen = !IsOpen;
    private void Close() => IsOpen = false;
    
    private async Task ApplyTime()
    {
        Value = new TimeSpan(selectedHour, selectedMinute, 0);
        await ValueChanged.InvokeAsync(Value);
        IsOpen = false;
    }
}

