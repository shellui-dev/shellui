@namespace BlazorInteractiveServer.Components.UI
@using Microsoft.JSInterop
@inject IJSRuntime JS

<div class="@("flex items-center " + ClassName)" @attributes="AdditionalAttributes">
    @for (int i = 0; i < Length; i++)
    {
        var index = i;
        var isGroupStart = GroupBy > 0 && i % GroupBy == 0;
        var isGroupEnd = GroupBy > 0 && (i + 1) % GroupBy == 0;
        
        @if (isGroupStart && i > 0)
        {
            <span class="text-muted-foreground text-xl font-bold mx-2">-</span>
        }
        
        <input @ref="_inputRefs[index]"
               id="@($"otp-input-{_id}-{index}")"
               type="text"
               inputmode="numeric"
               pattern="[0-9]*"
               maxlength="1"
               value="@GetDigit(index)"
               @oninput="@(e => HandleInput(index, e))"
               @onkeydown="@(e => HandleKeyDown(index, e))"
               @onpaste="@HandlePaste"
               @onfocus="@(() => _focusedIndex = index)"
               disabled="@Disabled"
               class="@("w-10 h-12 text-center text-lg font-semibold border-2 rounded-md transition-colors " + (Disabled ? "opacity-50 cursor-not-allowed bg-muted" : "bg-background") + " " + (_focusedIndex == index ? "border-ring ring-2 ring-ring ring-offset-2" : "border-input") + " focus:outline-none focus:border-ring focus:ring-2 focus:ring-ring focus:ring-offset-2 " + (isGroupEnd && i < Length - 1 ? "mr-0" : "mr-1"))" />
    }
</div>

@code {
    [Parameter]
    public string Value { get; set; } = "";
    
    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }
    
    [Parameter]
    public EventCallback<string> OnComplete { get; set; }
    
    [Parameter]
    public int Length { get; set; } = 6;
    
    [Parameter]
    public int GroupBy { get; set; } = 3;
    
    [Parameter]
    public bool Disabled { get; set; }
    
    [Parameter]
    public string ClassName { get; set; } = "";
    
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }
    
    private int _focusedIndex = -1;
    private ElementReference[] _inputRefs = null!;
    private string _id = Guid.NewGuid().ToString("N")[..8];
    
    protected override void OnInitialized()
    {
        _inputRefs = new ElementReference[Length];
    }
    
    private string GetDigit(int index) => index < Value.Length ? Value[index].ToString() : "";
    
    private async Task HandleInput(int index, ChangeEventArgs e)
    {
        var input = e.Value?.ToString() ?? "";
        if (string.IsNullOrEmpty(input) || !char.IsDigit(input[0])) 
        {
            return;
        }
        
        var newValue = Value.PadRight(Length, ' ');
        var chars = newValue.ToCharArray();
        chars[index] = input[0];
        Value = new string(chars).TrimEnd();
        
        await ValueChanged.InvokeAsync(Value);
        
        if (index < Length - 1)
        {
            await FocusInput(index + 1);
        }
        
        if (Value.Replace(" ", "").Length == Length)
        {
            await OnComplete.InvokeAsync(Value);
        }
    }
    
    private async Task HandleKeyDown(int index, KeyboardEventArgs e)
    {
        if (e.Key == "Backspace")
        {
            if (string.IsNullOrEmpty(GetDigit(index)) && index > 0)
            {
                var newValue = Value.PadRight(Length, ' ');
                var chars = newValue.ToCharArray();
                chars[index - 1] = ' ';
                Value = new string(chars).TrimEnd();
                await ValueChanged.InvokeAsync(Value);
                await FocusInput(index - 1);
            }
            else if (!string.IsNullOrEmpty(GetDigit(index)))
            {
                var newValue = Value.PadRight(Length, ' ');
                var chars = newValue.ToCharArray();
                chars[index] = ' ';
                Value = new string(chars).TrimEnd();
                await ValueChanged.InvokeAsync(Value);
            }
        }
        else if (e.Key == "ArrowLeft" && index > 0)
        {
            await FocusInput(index - 1);
        }
        else if (e.Key == "ArrowRight" && index < Length - 1)
        {
            await FocusInput(index + 1);
        }
    }
    
    private async Task HandlePaste(ClipboardEventArgs e)
    {
        await Task.CompletedTask;
    }
    
    private async Task FocusInput(int index)
    {
        if (index >= 0 && index < Length)
        {
            try
            {
                await JS.InvokeVoidAsync("ShellUI.focusElement", $"otp-input-{_id}-{index}");
            }
            catch
            {
            }
        }
    }
}
