@namespace BlazorInteractiveServer.Components.UI
@using BlazorInteractiveServer.Components

<CascadingValue Value="this" IsFixed="true">
    <div class="@Shell.Cn("relative inline-block", Class)" @attributes="AdditionalAttributes">
        @if (UseCompositional)
        {
            @ChildContent
        }
        else
        {
            <div @onclick="Toggle">
                @Trigger
            </div>
            @if (IsOpen)
            {
                <div class="@Shell.Cn("absolute z-50 w-72 rounded-md border border-border bg-popover p-4 text-popover-foreground shadow-md outline-none animate-in fade-in-0 zoom-in-95", GetPlacementClass())">
                    @ChildContent
                </div>
            }
        }
    </div>
    @if (IsOpen)
    {
        <div class="fixed inset-0 z-40" @onclick="Close"></div>
    }
</CascadingValue>

@code {
    [Parameter] public RenderFragment? Trigger { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public string Placement { get; set; } = "bottom";
    [Parameter] public string? Class { get; set; }
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private bool UseCompositional => Trigger is null;

    public async Task ToggleAsync()
    {
        IsOpen = !IsOpen;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }

    public async Task CloseAsync()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }

    private async Task Toggle() => await ToggleAsync();
    private async Task Close() => await CloseAsync();

    public string PlacementClass => GetPlacementClass();

    private string GetPlacementClass() => Placement switch
    {
        "top" => "bottom-full left-0 mb-2",
        "left" => "right-full top-0 mr-2",
        "right" => "left-full top-0 ml-2",
        _ => "top-full left-0 mt-2"
    };
}
