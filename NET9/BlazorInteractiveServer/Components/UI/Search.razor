@namespace BlazorInteractiveServer.Components.UI
@using Microsoft.JSInterop
@inject IJSRuntime JS

<!-- Search Trigger Button -->
<button type="button"
        @onclick="OpenSearch"
        class="@("flex items-center bg-muted/50 rounded-lg px-3 py-2 border border-border hover:bg-muted transition-colors " + ClassName)"
        @attributes="AdditionalAttributes">
    <svg class="w-4 h-4 text-muted-foreground mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
    </svg>
    <span class="text-sm text-muted-foreground flex-1 text-left">Search</span>
    <div class="flex gap-1">
        <kbd class="px-1.5 py-0.5 text-xs bg-muted rounded border border-border">Ctrl</kbd>
        <kbd class="px-1.5 py-0.5 text-xs bg-muted rounded border border-border">K</kbd>
    </div>
</button>

<!-- Search Modal -->
@if (_isOpen)
{
    <div class="fixed inset-0 z-50 flex items-start justify-center pt-[15vh]">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-background/80 backdrop-blur-sm" @onclick="CloseSearch"></div>
        
        <!-- Search Modal -->
        <div class="relative w-full max-w-2xl mx-4">
            <div class="bg-background border border-border rounded-lg shadow-lg">
                <!-- Search Input -->
                <div class="flex items-center px-4 py-3 border-b border-border">
                    <svg class="w-4 h-4 text-muted-foreground mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input @ref="_searchInput"
                           @bind="SearchQuery"
                           @bind:event="oninput"
                           @onkeydown="HandleKeyDown"
                           placeholder="Search components..."
                           class="flex-1 bg-transparent text-foreground placeholder:text-muted-foreground focus:outline-none text-sm" />
                    <kbd class="ml-2 px-1.5 py-0.5 text-xs bg-muted rounded border border-border">ESC</kbd>
                </div>
                
                <!-- Search Results -->
                <div class="max-h-96 overflow-y-auto">
                    @if (string.IsNullOrEmpty(SearchQuery))
                    {
                        <!-- Empty State -->
                        <div class="px-4 py-8 text-center text-muted-foreground">
                            <svg class="w-8 h-8 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <p class="text-sm">Type to search for components</p>
                        </div>
                    }
                    else
                    {
                        <!-- Search Results -->
                        @foreach (var result in GetSearchResults())
                        {
                            <button type="button"
                                    @onclick="@(() => SelectResult(result))"
                                    class="w-full px-4 py-3 text-left hover:bg-muted/50 transition-colors border-b border-border last:border-b-0">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded bg-primary/10 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-medium text-foreground">@result.Name</div>
                                        <div class="text-sm text-muted-foreground">@result.Description</div>
                                    </div>
                                    <div class="text-xs text-muted-foreground bg-muted px-2 py-1 rounded">
                                        @result.Category
                                    </div>
                                </div>
                            </button>
                        }
                        
                        @if (!GetSearchResults().Any())
                        {
                            <div class="px-4 py-8 text-center text-muted-foreground">
                                <p class="text-sm">No components found for "@SearchQuery"</p>
                            </div>
                        }
                    }
                </div>
                
                <!-- Footer -->
                <div class="px-4 py-2 border-t border-border bg-muted/20">
                    <div class="flex items-center justify-between text-xs text-muted-foreground">
                        <div class="flex items-center gap-4">
                            <span class="flex items-center gap-1">
                                <kbd class="px-1 py-0.5 bg-muted rounded border border-border">↑↓</kbd>
                                to navigate
                            </span>
                            <span class="flex items-center gap-1">
                                <kbd class="px-1 py-0.5 bg-muted rounded border border-border">↵</kbd>
                                to select
                            </span>
                        </div>
                        <span class="flex items-center gap-1">
                            <kbd class="px-1 py-0.5 bg-muted rounded border border-border">ESC</kbd>
                            to close
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string ClassName { get; set; } = "";
    
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }
    
    [Parameter]
    public EventCallback<string> OnComponentSelected { get; set; }
    
    private bool _isOpen = false;
    private string SearchQuery = "";
    private ElementReference _searchInput;
    
    // Sample component data - in real implementation, this would come from a service
    private readonly List<SearchResult> _components = new()
    {
        new("Button", "A clickable button component with multiple variants", "Form"),
        new("Input", "A text input field with validation support", "Form"),
        new("Card", "A flexible container for grouping related content", "Layout"),
        new("Dialog", "A modal dialog for important interactions", "Overlay"),
        new("Alert", "A banner for displaying important messages", "Feedback"),
        new("Badge", "A small status indicator or label", "Data Display"),
        new("Avatar", "A user profile picture component", "Data Display"),
        new("Table", "A data table with sorting and pagination", "Data Display"),
        new("Tabs", "A set of layered sections of content", "Navigation"),
        new("Accordion", "A vertically stacked set of collapsible content", "Layout"),
        new("DatePicker", "A date selection component", "Form"),
        new("TimePicker", "A time selection component", "Form"),
        new("Select", "A dropdown selection component", "Form"),
        new("Checkbox", "A checkbox input component", "Form"),
        new("Switch", "A toggle switch component", "Form"),
        new("Slider", "A range slider input component", "Form"),
        new("Progress", "A progress indicator component", "Feedback"),
        new("Skeleton", "A loading placeholder component", "Feedback"),
        new("Toast", "A temporary notification message", "Feedback"),
        new("Tooltip", "A contextual help text component", "Overlay")
    };
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("eval", @"
                document.addEventListener('keydown', function(e) {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        // This will be handled by the component
                    }
                });
            ");
        }
    }
    
    private async Task OpenSearch()
    {
        _isOpen = true;
        SearchQuery = "";
        StateHasChanged();
        
        // Focus the input after the modal is rendered
        await Task.Delay(50);
        try
        {
            await _searchInput.FocusAsync();
        }
        catch
        {
            // Ignore focus errors
        }
    }
    
    private async Task CloseSearch()
    {
        _isOpen = false;
        SearchQuery = "";
        StateHasChanged();
    }
    
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            await CloseSearch();
        }
        else if (e.Key == "Enter")
        {
            var results = GetSearchResults();
            if (results.Any())
            {
                await SelectResult(results.First());
            }
        }
    }
    
    private async Task SelectResult(SearchResult result)
    {
        await OnComponentSelected.InvokeAsync(result.Name);
        await CloseSearch();
    }
    
    private IEnumerable<SearchResult> GetSearchResults()
    {
        if (string.IsNullOrEmpty(SearchQuery))
            return Enumerable.Empty<SearchResult>();
            
        return _components.Where(c => 
            c.Name.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ||
            c.Description.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ||
            c.Category.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase)
        ).Take(10);
    }
    
    private record SearchResult(string Name, string Description, string Category);
}